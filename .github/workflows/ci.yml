name: CI

on:
  pull_request:
    branches: [ main ]

permissions:
  contents: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TEST_IMAGE_TAG: test-${{ github.sha }}
  FULL_TEST_IMAGE: ghcr.io/${{ github.repository }}:test-${{ github.sha }}
  SAFE_BRANCH_NAME: ${{ github.head_ref && github.head_ref || github.ref_name }}

jobs:
  test-and-build:
    name: Test and Build
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Sanitize branch name for Docker tags
      id: vars
      run: |
        BRANCH_NAME="${{ env.SAFE_BRANCH_NAME }}"
        SAFE_TAG=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
        echo "SAFE_TAG=$SAFE_TAG" >> $GITHUB_OUTPUT

    - name: Set up Ruby for Rake
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.4.4'
        bundler-cache: true

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=tag
          type=ref,event=pr
          type=sha

    - name: Build and push test image
      uses: docker/build-push-action@v5
      with:
        context: .
        target: test
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ steps.vars.outputs.SAFE_TAG }}
        cache-from: |
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ steps.vars.outputs.SAFE_TAG }}
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-main
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.SAFE_TAG }}
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
        cache-to: type=inline
        push: true
        load: true

    - name: Run RSpec tests
      run: |
        docker run --rm -e COVERAGE=true -e COVERAGE_DIR=/tmp/coverage \
          ${{ env.FULL_TEST_IMAGE }} \
          sh -c "cd /app && bundle exec rspec"

    - name: Run RuboCop
      run: |
        docker run --rm ${{ env.FULL_TEST_IMAGE }} \
          sh -c "cd /app && bundle exec rubocop"

    - name: Run Reek
      run: |
        docker run --rm ${{ env.FULL_TEST_IMAGE }} \
          sh -c "cd /app && bundle exec reek"

    - name: Run bundler-audit
      run: |
        docker run --rm ${{ env.FULL_TEST_IMAGE }} \
          sh -c "cd /app && bundle exec bundler-audit check --update"

    - name: Test examples
      run: |
        docker run --rm -v $PWD/examples:/app/examples:ro \
          ${{ env.FULL_TEST_IMAGE }} \
          /app/examples/test_examples_in_container.sh

    - name: Build and push production image
      if: success()
      uses: docker/build-push-action@v5
      with:
        context: .
        target: production
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.SAFE_TAG }}
          ${{ github.ref == 'refs/heads/main' && format('{0}/{1}:latest', env.REGISTRY, env.IMAGE_NAME) || '' }}
        cache-from: |
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.SAFE_TAG }}
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:main
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ steps.vars.outputs.SAFE_TAG }}
          type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-main
        cache-to: type=inline
        push: true
        load: true

    - name: Smoke test production image
      if: success()
      run: |
        RESPONSE=$(echo '{"jsonrpc":"2.0","id":1,"method":"initialize"}' | \
          docker run --rm -i ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} 2>/dev/null)
        echo "Response: $RESPONSE"
        if echo "$RESPONSE" | grep -q "protocolVersion"; then
          echo "✅ Production image smoke test passed"
        else
          echo "❌ Production image smoke test failed"
          exit 1
        fi

    - name: Summary of pushed images
      if: success()
      run: |
        {
          echo "## Docker Images Published"
          echo ""
          echo "### Test Image:"
          echo "- \`${{ env.FULL_TEST_IMAGE }}\`"
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ steps.vars.outputs.SAFE_TAG }}\`"
          echo ""
          echo "### Production Image:"
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}\`"
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.SAFE_TAG }}\`"
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`"
          fi
        } >> $GITHUB_STEP_SUMMARY